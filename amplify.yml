applications:
  - appRoot: projects/control-plane
    frontend:
      phases:
        preBuild:
          commands:
            - npm install
        build:
          commands:
            - npm run build
      artifacts:
        baseDirectory: dist
        files:
          - '**/*'
      cache:
        paths:
          - .npm/**/*
          - node_modules/**/*
    backend:
      phases:
        build:
          commands:
            - npm ci --cache .npm --prefer-offline
            # outputsファイルを参照するバックエンドリソースために、空のoutputsファイルを作成しておく
            - "echo '{\"version\": \"1.4\"}' > amplify_outputs.json"
            - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
  - appRoot: projects/intersection
    env:
      variables:
        CONTROL_PLANE_APP_ID: d2tluq7eukvnud
    frontend:
      phases:
        preBuild:
          commands:
            - npm install
        build:
          commands:
            - npm run build
      artifacts:
        baseDirectory: dist
        files:
          - '**/*'
      cache:
        paths:
          - .npm/**/*
          - node_modules/**/*
    backend:
      phases:
        build:
          commands:
            - npm ci --cache .npm --prefer-offline
            # リソースを共有したい、作成済みのコントロールプレーン側のリソース設定をエクスポートする
            - npx ampx generate outputs --branch $AWS_BRANCH --app-id $CONTROL_PLANE_APP_ID --out-dir shared
            # 自分自身のリソースをデプロイする
            - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID