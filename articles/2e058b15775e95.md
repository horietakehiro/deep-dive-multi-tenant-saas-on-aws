---
title: "【第01章幕間】Deep Dive マルチテナントSaaS on AWS - 初期環境構築"
emoji: "🤿"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["aws", "saas"]
published: false
---

## はじめに

[第 00 回](TODO:)でも述べた通り、この学習を通して簡易的なマルチテナント SaaS アプリケーション(`intersection`)及びそれを管理するためのコントロールプレーンを開発していきます。ここではその初期検討 - 使用する技術スタックや Git リポジトリ上の構成 - を行い、初期環境を整備していきたいと思います。

## 使用する技術スタック

- intersection、コントロールプレーン共に、SPA(シングルページアプリケーション)として実装する。バックエンドは Lambda や DynamoDB を始めとするサーバレスサービスを極力使用する。主に AWS 利用料節約のため
  - フレームワークとして React を使用する。私が現在辛うじて馴染みのあるフレームワークであるため
  - AWS サービスとの連携及び SPA のホスティングには、[Amplify Gen2](https://docs.amplify.aws/)を使用する。

## Git リポジトリの構成

上記より、React + Amplify の開発環境を準備する必要があります。それに伴い考えなければいけないのは以下の 2 点です。

- アプリケーションの分割戦略 : 本プロジェクトでは intersection とコントロールプレーンの 2 種類のアプリケーションを開発・デプロイする必要がある。それらをどのように分割して管理すべきか(リポジトリ単位で分割するか、1 つのリポジトリに集約管理するか、等)
- 具体的な初期設定手順 : 上記の分割戦略に基づいて、React + Amplify の WEB アプリケーションの開発に着手するための初期環境を具体的にどういった手順で用意することができるか。

### アプリケーションの分割戦略

結論から述べると、本プロジェクトではモノレポ構成を採用したいと思います。つまり、[単一のリポジトリ](https://github.com/horietakehiro/deep-dive-multi-tenant-saas-on-aws)内にフォルダを分けて、intersection とコントロールプレーンの 2 種類のアプリケーションを管理していきます。そのようにする理由は以下の通りです。

- intersection とコントロールプレーン間で共有したいリソース設定や型情報が今後発生することが見込まれる。モノレポ構成にすることでそういった共有をスムーズに行えることを期待する。
- 加えて、Amplify Gen2 では[モノレポ内の特定アプリケーションのデプロイ](https://docs.aws.amazon.com/ja_jp/amplify/latest/userguide/monorepo-configuration.html)にも対応しているため。

### 具体的な初期設定手順

プロジェクトの基本構成として[AWS がサンプルで公開しているこちらのリポジトリ](https://github.com/aws-samples/amplify-vite-react-template)を参考に、vite 経由で React プロジェクトのベースを作成し、そこに Amplify の初期設定を加える、という形にしました。

```bash
$ node -v
v22.11.0
$ npm -v
10.9.0
# まずはコントロールプレーン側を初期設定
$ mkdir projects && cd projects
# フレームワークとしてReact、バリアントとしてTypeScriptを選択
$ npm create vite@latest
> npx
> create-vite

│
◇  Project name:
│  control-plane
│
◇  Select a framework:
│  React
│
◇  Select a variant:
│  TypeScript
│
◇  Scaffolding project in /home/horie-t/deep-dive-multi-tenant-saas-on-aws/projects/control-plane/control-plane...
│
└  Done. Now run:

  cd control-plane
  npm install
  npm run dev
$ npm create amplify@latest

> control-plane@0.0.0 npx
> create-amplify

✔ Where should we create your project? .

10:29:03 AM Installing devDependencies:
10:29:03 AM  - @aws-amplify/backend
10:29:03 AM  - @aws-amplify/backend-cli
10:29:03 AM  - aws-cdk-lib@2.189.1
10:29:03 AM  - constructs@^10.0.0
10:29:03 AM  - typescript@^5.0.0
10:29:03 AM  - tsx
10:29:03 AM  - esbuild

10:29:03 AM Installing dependencies:
10:29:03 AM  - aws-amplify

10:29:03 AM ✔ 10:30:41 AM DevDependencies installed
10:30:41 AM ✔ 10:34:16 AM Dependencies installed
10:34:16 AM ✔ 10:34:16 AM Template files created
10:34:16 AM Successfully created a new project!

10:34:16 AM Welcome to AWS Amplify!
10:34:16 AM  - Get started by running npx ampx sandbox.
10:34:16 AM  - Run npx ampx help for a list of available commands.

10:34:16 AM Amplify collects anonymous telemetry data about general usage of the CLI. Participation is optional, and you may opt-out by using npx ampx configure telemetry disable. To learn more about telemetry, visit https://docs.amplify.aws/react/reference/telemetry
# 上記コマンドだけではインストールされないライブラリは手動でインストールする
$ npm install @aws-amplify/ui-react
```

コマンド`npm create vite@latest`によってまず(vite によって)React の環境が作成され、次にコマンド`npm create amplify@latest`によって Amplify 向けのファイルの作成とライブラリのインストールが一通り実行されました。

この時点で Amplify - つまり AWS 上のバックエンドリソースと正しく連携して React アプリケーションが動作するかを簡単に確認していきます。

- Amplify 上にサンドボックス環境をデプロイし、

```bash
$ npx ampx sandbox
```

- 初期設定直後のコードに、Cognito と連携する Authenticator の設定を追加し、

```js: src/main.tsx
import { StrictMode } from "react";
import { createRoot } from "react-dom/client";
import "./index.css";
import App from "./App.tsx";
import { Amplify } from "aws-amplify";
import outputs from "../amplify_outputs.json";

import { Authenticator } from "@aws-amplify/ui-react";
import "@aws-amplify/ui-react/styles.css";

Amplify.configure(outputs);
createRoot(document.getElementById("root")!).render(
  <StrictMode>
    <Authenticator>
      <App />
    </Authenticator>
  </StrictMode>
);

```

- ローカルで WEB ページを起動し、Cognito と連携したサインアップ及びサインインが成功するかを確認します。

```bash
$ npm run dev
```

![](/images/00-interlude/signup.png)

![](/images/00-interlude/signin.png)

React と Amplify(Cognito)との連携がワンパス通っていることを確認できました。

同じ要領で、intersection 側のプロジェクトも初期化していきます。

## Amplify へのデプロイ

Sandbok 上でワンパス通ることが確認出来たので、試しにコントロールプレーンを Amplify にデプロイしていきます。

Amplify 公式のガイドを参考に、モノレポ向けのビルド設定ファイルを作成します。

```yaml: amplify.yml

```

### プロジェクト間の連携を確認する

[こちら](#アプリケーションの分割戦略)で述べたように、プロジェクト間でリソースや型情報を共有しあえるようにするというのがモノレポ構成を採用した狙いでした。現在のリポジトリ構成でそれが上手く機能しているか確認していきます。

- コントロールプレーン側に適当な形情報と関数を定義し、

```js: projects/control-plane/src/share.ts
export interface GreetProps {
  from: string;
  to: string;
}
export const greet = (props: GreetProps): string => {
  return `Hello ${props.to} ! by ${props.from}`;
};
```

- intersection 側の`tsconfig`でその定義を参照できるようにします。

```json: projects/intersection/tsconfig.app.json
  "include": ["src", "../control-plane/src", "../control-plane/amplify"]
```

- intersection 側でその型情報と関数を使用します。

```js: projects/intersection/src/App.tsx
        <p>
          {greet({ from: "James", to: "Curry" })}
          {/* Edit <code>src/App.tsx</code> and save to test HMR */}
        </p>
```

- また、control-plane 側で定義した AWS リソース(Cognito ユーザープール)を intersection 側で参照します。

```js: projects/intersection/amplify/backend.ts
// import { auth } from './auth/resource';
import { auth } from "../../control-plane/amplify/auth/resource";
```

- 上記の設定を施して intersection 側の WEB ページを起動すると、無事コントロールプレーン側のリソースや関数を参照出来ていることが確認出来ました。

![](/images//00-interlude/share-resource.png)
