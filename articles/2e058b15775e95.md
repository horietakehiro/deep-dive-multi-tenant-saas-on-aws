---
title: "ã€ç¬¬01ç« å¹•é–“ã€‘Deep Dive ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆSaaS on AWS - åˆæœŸç’°å¢ƒæ§‹ç¯‰"
emoji: "ğŸ¤¿"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["aws", "saas"]
published: false
---

## ã¯ã˜ã‚ã«

[ç¬¬ 00 å›](TODO:)ã§ã‚‚è¿°ã¹ãŸé€šã‚Šã€ã“ã®å­¦ç¿’ã‚’é€šã—ã¦ç°¡æ˜“çš„ãªãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆ SaaS ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³(`intersection`)åŠã³ãã‚Œã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ã‚’é–‹ç™ºã—ã¦ã„ãã¾ã™ã€‚ã“ã“ã§ã¯ãã®åˆæœŸæ¤œè¨ - ä½¿ç”¨ã™ã‚‹æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã®é¸å®šã‚„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆã®æ¤œè¨ - ã‚’è¡Œã„ã€åˆæœŸç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

## ä½¿ç”¨ã™ã‚‹æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- intersectionã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³å…±ã«ã€SPA(ã‚·ãƒ³ã‚°ãƒ«ãƒšãƒ¼ã‚¸ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³)ã¨ã—ã¦å®Ÿè£…ã™ã‚‹ã€‚ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯ Lambda ã‚„ DynamoDB ã‚’å§‹ã‚ã¨ã™ã‚‹ã‚µãƒ¼ãƒãƒ¬ã‚¹ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ¥µåŠ›ä½¿ç”¨ã™ã‚‹ã€‚ä¸»ã« AWS åˆ©ç”¨æ–™ç¯€ç´„ã®ãŸã‚
  - ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨ã—ã¦ React ã‚’ä½¿ç”¨ã™ã‚‹ã€‚ç§ãŒç¾åœ¨è¾›ã†ã˜ã¦é¦´æŸ“ã¿ã®ã‚ã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã‚ã‚‹ãŸã‚
  - AWS ã‚µãƒ¼ãƒ“ã‚¹ã¨ã®é€£æºåŠã³ SPA ã®ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã«ã¯ã€[Amplify Gen2](https://docs.amplify.aws/)ã‚’ä½¿ç”¨ã™ã‚‹ã€‚

## æ¤œè¨ãƒ»å®Ÿæ–½äº‹é …

ä¸Šè¨˜ã‚ˆã‚Šã€React + Amplify ã®é–‹ç™ºç’°å¢ƒã‚’æº–å‚™ã—ã¦ã„ãã¾ã™ã€‚æœ¬è¨˜äº‹å†…ã§æ¤œè¨åŠã³å®Ÿæ–½ã—ã¦ã„ããŸã„äº‹é …ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆ†å‰²æˆ¦ç•¥ã‚’æ¤œè¨ã™ã‚‹** : æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ intersection ã¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ã® 2 ç¨®é¡ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹ç™ºãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚ãã‚Œã‚‰ã‚’ã©ã®ã‚ˆã†ã«åˆ†å‰²ã—ã¦ç®¡ç†ã™ã¹ãã‹ã‚’æ¤œè¨ã™ã‚‹ã€‚å…·ä½“çš„ã«ã¯ã€ãƒªãƒã‚¸ãƒˆãƒªå˜ä½ã§åˆ†å‰²ã™ã‚‹ã‹ã€1 ã¤ã®ãƒªãƒã‚¸ãƒˆãƒªã«é›†ç´„ç®¡ç†ã™ã‚‹ã‹ã€‚
- **å…·ä½“çš„ãªåˆæœŸç’°å¢ƒã®æ§‹ç¯‰æ‰‹é †ã‚’èª¿æŸ»ã—å®Ÿè¡Œã™ã‚‹** : ä¸Šè¨˜ã®åˆ†å‰²æˆ¦ç•¥ã«åŸºã¥ã„ã¦ã€React + Amplify ã® WEB ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é–‹ç™ºã«ç€æ‰‹ã™ã‚‹ãŸã‚ã®åˆæœŸç’°å¢ƒã‚’å…·ä½“çš„ã«ã©ã†ã„ã£ãŸæ‰‹é †ã§æ§‹ç¯‰ã™ã¹ãã‹ã‚’èª¿æŸ»ã—å®Ÿæ–½ã™ã‚‹ã€‚
- **ãƒ¯ãƒ³ãƒ‘ã‚¹ãƒ¬ãƒ™ãƒ«ã®ç°¡å˜ãªå‹•ç¢ºã‚’ä¸€é€šã‚Šè¡Œã†** : æ§‹ç¯‰ã—ãŸåˆæœŸç’°å¢ƒã§ã€Amplify ã¨é€£æºã—ã¦ WEB ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒå‹•ä½œã™ã‚‹ã‹ã‚’ãƒ¯ãƒ³ãƒ‘ã‚¹ãƒ¬ãƒ™ãƒ«ã§å‹•ç¢ºã™ã‚‹

### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆ†å‰²æˆ¦ç•¥

çµè«–ã‹ã‚‰è¿°ã¹ã‚‹ã¨ã€æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ãƒ¢ãƒãƒ¬ãƒæ§‹æˆã‚’æ¡ç”¨ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚ã¤ã¾ã‚Šã€[å˜ä¸€ã®ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/horietakehiro/deep-dive-multi-tenant-saas-on-aws)å†…ã«ãƒ•ã‚©ãƒ«ãƒ€ã‚’åˆ†ã‘ã¦ã€intersection ã¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ã® 2 ç¨®é¡ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç®¡ç†ã—ã¦ã„ãã¾ã™ã€‚ãã®ã‚ˆã†ã«ã™ã‚‹ç†ç”±ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- intersection ã¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³é–“ã§å…±æœ‰ã—ãŸã„ãƒªã‚½ãƒ¼ã‚¹è¨­å®šã‚„å‹æƒ…å ±ãŒä»Šå¾Œç™ºç”Ÿã™ã‚‹ã“ã¨ãŒè¦‹è¾¼ã¾ã‚Œã‚‹ã€‚ãƒ¢ãƒãƒ¬ãƒæ§‹æˆã«ã™ã‚‹ã“ã¨ã§ãã†ã„ã£ãŸå…±æœ‰ã‚’ã‚¹ãƒ ãƒ¼ã‚ºã«è¡Œãˆã‚‹ã“ã¨ã‚’æœŸå¾…ã™ã‚‹ã€‚
- åŠ ãˆã¦ã€Amplify Gen2 ã§ã¯[ãƒ¢ãƒãƒ¬ãƒå†…ã®ç‰¹å®šã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤](https://docs.aws.amazon.com/ja_jp/amplify/latest/userguide/monorepo-configuration.html)ã«ã‚‚å¯¾å¿œã—ã¦ã„ã‚‹ãŸã‚ã€‚

### åˆæœŸç’°å¢ƒæ§‹ç¯‰

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åŸºæœ¬æ§‹æˆã¨ã—ã¦[AWS ãŒã‚µãƒ³ãƒ—ãƒ«ã§å…¬é–‹ã—ã¦ã„ã‚‹ã“ã¡ã‚‰ã®ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/aws-samples/amplify-vite-react-template)ã‚’å‚è€ƒã«ã€vite çµŒç”±ã§ React ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã€ãã“ã« Amplify ã®åˆæœŸè¨­å®šã‚’åŠ ãˆã‚‹ã€ã¨ã„ã†å½¢ã«ã—ã¾ã—ãŸã€‚

```bash
$ node -v
v22.11.0
$ npm -v
10.9.0
# ã¾ãšã¯ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³å´ã‚’åˆæœŸè¨­å®š
$ mkdir projects && cd projects
# ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨ã—ã¦Reactã€ãƒãƒªã‚¢ãƒ³ãƒˆã¨ã—ã¦TypeScriptã‚’é¸æŠ
$ npm create vite@latest
> npx
> create-vite

â”‚
â—‡  Project name:
â”‚  control-plane
â”‚
â—‡  Select a framework:
â”‚  React
â”‚
â—‡  Select a variant:
â”‚  TypeScript
â”‚
â—‡  Scaffolding project in /home/horie-t/deep-dive-multi-tenant-saas-on-aws/projects/control-plane/control-plane...
â”‚
â””  Done. Now run:

  cd control-plane
  npm install
  npm run dev
$ npm create amplify@latest

> control-plane@0.0.0 npx
> create-amplify

âœ” Where should we create your project? .

10:29:03 AM Installing devDependencies:
10:29:03 AM  - @aws-amplify/backend
10:29:03 AM  - @aws-amplify/backend-cli
10:29:03 AM  - aws-cdk-lib@2.189.1
10:29:03 AM  - constructs@^10.0.0
10:29:03 AM  - typescript@^5.0.0
10:29:03 AM  - tsx
10:29:03 AM  - esbuild

10:29:03 AM Installing dependencies:
10:29:03 AM  - aws-amplify

10:29:03 AM âœ” 10:30:41 AM DevDependencies installed
10:30:41 AM âœ” 10:34:16 AM Dependencies installed
10:34:16 AM âœ” 10:34:16 AM Template files created
10:34:16 AM Successfully created a new project!

10:34:16 AM Welcome to AWS Amplify!
10:34:16 AM  - Get started by running npx ampx sandbox.
10:34:16 AM  - Run npx ampx help for a list of available commands.

10:34:16 AM Amplify collects anonymous telemetry data about general usage of the CLI. Participation is optional, and you may opt-out by using npx ampx configure telemetry disable. To learn more about telemetry, visit https://docs.amplify.aws/react/reference/telemetry
# ä¸Šè¨˜ã‚³ãƒãƒ³ãƒ‰ã ã‘ã§ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œãªã„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯æ‰‹å‹•ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
$ npm install @aws-amplify/ui-react
```

ã‚³ãƒãƒ³ãƒ‰`npm create vite@latest`ã«ã‚ˆã£ã¦ã¾ãš(vite ã«ã‚ˆã£ã¦)React ã®ç’°å¢ƒãŒä½œæˆã•ã‚Œã€æ¬¡ã«ã‚³ãƒãƒ³ãƒ‰`npm create amplify@latest`ã«ã‚ˆã£ã¦ Amplify å‘ã‘ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒä¸€é€šã‚Šå®Ÿè¡Œã•ã‚Œã¾ã—ãŸã€‚

## ãƒ¯ãƒ³ãƒ‘ã‚¹ãƒ¬ãƒ™ãƒ«ã®å‹•ç¢º

### ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®å‹•ç¢º

ã¾ãšã¯ Amplify ã® Sandbok ç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸãƒªã‚½ãƒ¼ã‚¹ã¨ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§èµ·å‹•ã—ãŸ WEB ãƒšãƒ¼ã‚¸ã¨ãŒæ­£ã—ãé€£æºã—ã¦å‹•ä½œã™ã‚‹ã‹ã‚’ç°¡å˜ã«ç¢ºèªã—ã¦ã„ãã¾ã™ã€‚

- Amplify ä¸Šã«ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç’°å¢ƒã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã€

```bash
$ npx ampx sandbox
```

- åˆæœŸè¨­å®šç›´å¾Œã®ã‚³ãƒ¼ãƒ‰ã«ã€Cognito ã¨é€£æºã™ã‚‹ Authenticator ã®è¨­å®šã‚’è¿½åŠ ã—ã€

```js: src/main.tsx
import { StrictMode } from "react";
import { createRoot } from "react-dom/client";
import "./index.css";
import App from "./App.tsx";
import { Amplify } from "aws-amplify";
import outputs from "../amplify_outputs.json";

import { Authenticator } from "@aws-amplify/ui-react";
import "@aws-amplify/ui-react/styles.css";

Amplify.configure(outputs);
createRoot(document.getElementById("root")!).render(
  <StrictMode>
    <Authenticator>
      <App />
    </Authenticator>
  </StrictMode>
);

```

- ãƒ­ãƒ¼ã‚«ãƒ«ã§ WEB ãƒšãƒ¼ã‚¸ã‚’èµ·å‹•ã—ã€Cognito ã¨é€£æºã—ãŸã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—åŠã³ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãŒæˆåŠŸã™ã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚

```bash
$ npm run dev
```

![](/images/00-interlude/signup.png)

![](/images/00-interlude/signin.png)

React ã¨ Amplify(Cognito)ã¨ã®é€£æºãŒãƒ¯ãƒ³ãƒ‘ã‚¹é€šã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã—ãŸã€‚

åŒã˜è¦é ˜ã§ã€intersection å´ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚‚åˆæœŸåŒ–ã—ã¦ã„ãã¾ã™ã€‚

### Amplify ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

Sandbok ä¸Šã§ãƒ¯ãƒ³ãƒ‘ã‚¹é€šã‚‹ã“ã¨ãŒç¢ºèªå‡ºæ¥ãŸã®ã§ã€è©¦ã—ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ã‚’ Amplify ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã„ãã¾ã™ã€‚

Amplify å…¬å¼ã®ã‚¬ã‚¤ãƒ‰ã‚’å‚è€ƒã«ã€ãƒ¢ãƒãƒ¬ãƒå‘ã‘ã®ãƒ“ãƒ«ãƒ‰è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```yaml: amplify.yml
applications:
  - appRoot: projects/control-plane
    frontend:
      phases:
        preBuild:
          commands:
            - npm install
        build:
          commands:
            - npm run build
      artifacts:
        baseDirectory: dist
        files:
          - '**/*'
      cache:
        paths:
          - .npm/**/*
          - node_modules/**/*
    backend:
      phases:
        build:
          commands:
            - npm ci --cache .npm --prefer-offline
            - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
```

ãƒªãƒã‚¸ãƒˆãƒªã‚’ GitHub ã«ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ã€Amplify ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ä¸Šã§ GitHub ãƒªãƒã‚¸ãƒˆãƒªã¨ã®é€£æºè¨­ã‚’è¡Œã£ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã€æœŸå¾…é€šã‚Š(Cognito ã¨é€£æºã—ãŸçŠ¶æ…‹ã®)ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«æˆåŠŸã—ã¾ã—ãŸ

![](/images/00-interlude/control-plane-deploy-success.png)

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–“ã®é€£æºã‚’ç¢ºèªã™ã‚‹

[ã“ã¡ã‚‰](#ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆ†å‰²æˆ¦ç•¥)ã§è¿°ã¹ãŸã‚ˆã†ã«ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–“ã§ãƒªã‚½ãƒ¼ã‚¹ã‚„å‹æƒ…å ±ã‚’å…±æœ‰ã—ã‚ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ã¨ã„ã†ã®ãŒãƒ¢ãƒãƒ¬ãƒæ§‹æˆã‚’æ¡ç”¨ã—ãŸç‹™ã„ã§ã—ãŸã€‚ç¾åœ¨ã®ãƒªãƒã‚¸ãƒˆãƒªæ§‹æˆã§ãã‚ŒãŒä¸Šæ‰‹ãæ©Ÿèƒ½ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ã„ãã¾ã™ã€‚å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã® 2 ç‚¹ã‚’ç¢ºèªã—ã¦ã„ãã¾ã™ã€‚

1. ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³å´ã§å®Ÿè£…ã—ãŸå‹æƒ…å ±ã‚„é–¢æ•°ã‚’ intersection å´ã§ã‚‚ä½¿ç”¨ã§ãã‚‹ã“ã¨
2. ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³å´ã§å®Ÿè£…ã—ãŸ AWS ãƒªã‚½ãƒ¼ã‚¹ã‚’ intersection å´ã§ã‚‚ä½¿ç”¨ã§ãã‚‹ã“ã¨

ã¾ãšã¯`1.`ã«ã¤ã„ã¦å¯¾å¿œã—ã¦ã„ãã¾ã™ã€‚

- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³å´ã«é©å½“ãªå½¢æƒ…å ±ã¨é–¢æ•°ã‚’å®šç¾©ã—ã€

```js: projects/control-plane/src/share.ts
export interface GreetProps {
  from: string;
  to: string;
}
export const greet = (props: GreetProps): string => {
  return `Hello ${props.to} ! by ${props.from}`;
};
```

- intersection å´ã®`tsconfig`ã§ãã®å®šç¾©ã‚’å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```json: projects/intersection/tsconfig.app.json
    "baseUrl": ".",
    "paths": {
      "@/shared": ["../control-plane/src/share"]
    }
```

- ä¸Šè¨˜ã®é€šã‚Š`paths`ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã®ã§ã€å¿…è¦ãª vite ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«åŠã³è¨­å®šã—ã¾ã™ã€‚

```bash
$ npm i -D vite-tsconfig-paths
```

```js: projects/intersection/vite.config.ts
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";
import tsconfigpaths from "vite-tsconfig-paths";

// https://vite.dev/config/
export default defineConfig({
  plugins: [react(), tsconfigpaths()],
});
```

- intersection å´ã§ãã®å‹æƒ…å ±ã¨é–¢æ•°ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```js: projects/intersection/src/App.tsx
        <p>
          {greet({ from: "James", to: "Curry" })}
          {/* Edit <code>src/App.tsx</code> and save to test HMR */}
        </p>
```

å°‘ãªãã¨ã‚‚ IDE ä¸Šã¯ã€ãã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã® WEB ãƒšãƒ¼ã‚¸ä¸Šã¯å•é¡Œç„¡ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã—ãŸã€‚

æ¬¡ã«`2.`ã«ã¤ã„ã¦å¯¾å¿œã—ã¦ã„ãã¾ã™ã€‚

- control-plane å´ã§æ—¢ã«ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ã® AWS ãƒªã‚½ãƒ¼ã‚¹(Cognito ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«)ã®è¨­å®šã‚’ intersection å´ã§å‚ç…§ã§ãã‚‹ã‚ˆã†ã€amplify ã®ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’åˆ†ã‘ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚

```bash
$ npx ampx generate outputs --branch main --app-id $CONTROL_PLANE_APP_ID --out-dir shared
File written: shared/amplify_outputs.json
```

- intersection ã® Amplify è¨­å®šèª­ã¿è¾¼ã¿ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã€(ä»Šå›ã®ä¾‹ã§ã‚ã‚Œã°)ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³å´ã® Cognito ãƒªã‚½ãƒ¼ã‚¹ã‚’å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```js: projects/intersection/src/main.tsx
import sharedOutputs from "../shared/amplify_outputs.json";
// ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³å´ã‹ã‚‰å…±æœ‰ã—ãŸã„
// ãƒªã‚½ãƒ¼ã‚¹è¨­å®šã‚’ä¸Šæ›¸ãã™ã‚‹
Amplify.configure({
  ...outputs,
  auth: sharedOutputs.auth,
});
```

- ä¸Šè¨˜å†…å®¹ã‚’ãƒ“ãƒ«ãƒ‰è¨­å®šã«ã‚‚è¿½è¨˜ã—ã¦ã€intersection ã®ã‚¢ãƒ—ãƒªã‚’ Amplify ä¸Šã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

```yaml: amplify.yml
  - appRoot: projects/intersection
    env:
      variables:
        CONTROL_PLANE_APP_ID: d2tluq7eukvnud
    frontend:
      phases:
        preBuild:
          commands:
            - npm install
        build:
          commands:
            - npm run build
      artifacts:
        baseDirectory: dist
        files:
          - '**/*'
      cache:
        paths:
          - .npm/**/*
          - node_modules/**/*
    backend:
      phases:
        build:
          commands:
            - npm ci --cache .npm --prefer-offline
            # ãƒªã‚½ãƒ¼ã‚¹ã‚’å…±æœ‰ã—ãŸã„ã€ä½œæˆæ¸ˆã¿ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³å´ã®ãƒªã‚½ãƒ¼ã‚¹è¨­å®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹
            - npx ampx generate outputs --branch $AWS_BRANCH --app-id $CONTROL_PLANE_APP_ID --out-dir shared
            # è‡ªåˆ†è‡ªèº«ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹
            - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
```

- ä¸Šè¨˜ã®è¨­å®šã‚’æ–½ã—ã¦ intersection ã‚’ Amplify ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ã€ç„¡äº‹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³å´ã® Cognito åŠã³é–¢æ•°ã‚’ä½¿ç”¨å‡ºæ¥ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªå‡ºæ¥ã¾ã—ãŸã€‚

![](/images//00-interlude/intersection-deploy-success.png)

## ã¾ã¨ã‚

ä»¥ä¸Šã§ã€React + Amplify ã® 2 ç¨®é¡ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºç’°å¢ƒã‚’ãƒ¢ãƒãƒ¬ãƒå†…ã«åˆæœŸæ§‹ç¯‰ã—ã€ä¸€é€šã‚Šã®ãƒ¯ãƒ³ãƒ‘ã‚¹ãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªå‡ºæ¥ã¾ã—ãŸã€‚é–‹ç™ºã®éç¨‹ã§ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆç­‰ã¯ãã®éƒ½åº¦å¤‰æ›´ã—ã¦ã„ãã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ã²ã¨ã¾ãšã¯ã“ã®æ§‹æˆã‚’ãƒ™ãƒ¼ã‚¹ã«é€²ã‚ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚
