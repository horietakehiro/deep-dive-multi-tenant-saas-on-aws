---
title: "【第08回】Deep Dive マルチテナントSaaS on AWS - 第6章振返り"
emoji: "🤿"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["aws", "saas"]
published: false
---

## はじめに

本記事では、「[マルチテナント SaaS アーキテクチャの構築 ― 原則、ベストプラクティス、AWS アーキテクチャパターン](https://www.oreilly.co.jp/books/9784814401017/)の第 5 章「テナントの認証とルーティング」の内容を振り返り、自分なりに要点を整理していきます。

6 章では、アプリケーションにアクセスするための認証及びルーティングの仕組みについて考えていきます。

---

## 正面玄関から入る

まずは、アプリケーションへアクセスする方法の検討からスタートします。各テナントにアプリケーションへのアクセスする方法としては主に以下の選択肢が挙げられます。

- 各テナント情報をアプリケーションドメインドメインに含め、各テナントは対応するドメインにアクセスする
- 共通するアプリケーションドメインに全てのテナントがアクセスする

これらのうちどの方法を選択するかによって、SaaS アーキテクチャの他の側面にも様々な影響をもたらします。それらの影響について詳しく確認していきます。

### テナントドメイン経由でのアクセス

まずは、テナントを識別する情報が含まれドメイン経由でアクセスする方法について考えていきます。

![](/images/08/access-by-tenant-domain.drawio.png)

このアプローチでは、各テナントからの全てのリクエストは、上図でテナントマッピングと表現されるエンティテを経由します。テナントエンティティでは、各テナントのドメインを適切なバックエンドサービスにルーティングするための一連の技術、インフラストラクチャ、サービスを意味しています。

このアプローチが利用される主なユースケースは、テナントごとに個別のアイデンティティプロバイダが割り当てられていたり、アプリケーションプレーンがテナントごとにサイロ化していたりする場合です。テナントマッピングはドメインから適切な宛先にリクエストをルーティングすることが出来ます。

アプリケーションドメインへのテナント情報の具体的な含め方は大きく 2 つ考えられます。1 つは、サブドメインにテナント情報を含める方式です(tenant1.example.com, tenant2.example.com といった具合)。この方式は大きな複雑性やオーバーヘッドを伴わずに実現する可能性が高いです。もう 1 つは、テナントごとに独立したバニティドメインを割り当てることです。この方式は、ブランディング等の目的でテナントが独自のドメインを使用したい場合に有効といえます。

### 単一ドメイン経由でのアクセス

次に考えるのは、すべてのテナントに対して 1 つのドメインを使用する方式です。これは特に B2C の SaaS プロバイダで用いられるアクセス方式です。

![](/images/08/access-by-common-domain.drawio.png)

この方式では上図のように、単一のアイデンティティプロバイによって、全てのテナントユーザが認証されます。アイデンティティプロバイダがグループ化構造をサポートしている場合、テナントごとに個別の認証ポリシーを適用することが出来ます。ただしその際、適用すべきポリシーをユーザ情報から識別する方法を検討する必要があります。具体例の一つとしては、下図のように個々のユーザ情報とテナントとのマッピングをテナント管理サービス上で保管し、このマッピング情報に応じて、認証時にテナントごとの認証ポリシーを適用する、といった具合です。

![](/images/08/access-by-common-domain-with-tenant-info.drawio.png)

---

## マルチテナントの認証フロー

ここではひとまず、認証リクエストが適切なアイデンティティプロバイダにルーティングされる方法が確立されたと仮定し、次は認証プロセスの残りのプロセス、つまりはテナントユーザを認証し、SaaS アイデンティティをレスポンスすること、について考えていきます。

### 認証フローの例

下図はここで詳しく見ていく認証フローの概念図です。

![](/images/08/auth-flow-concept.drawio.png)
